# =============================================================================
# AWS Sandbox - Root Taskfile for External Users
# =============================================================================
# Entry point for external users of aws-sandbox npm package
# Docs: https://www.npmjs.com/package/aws-sandbox
# =============================================================================

version: '3'

vars:
  VERSION: "0.2.9"
  EVIDENCE_DIR: "/workspace/tmp/aws-sandbox"

includes:
  sandbox:
    taskfile: ./aws-sandbox/Taskfile.yml
    dir: ./aws-sandbox

tasks:
  default:
    desc: Run quickstart (end-to-end validation)
    cmds:
      - task: quickstart

  quickstart:
    desc: End-to-end validation for external users (EXECUTES full workflow)
    cmds:
      - |
        echo "╔══════════════════════════════════════════════════════════════╗"
        echo "║          AWS Sandbox Quick Start v{{.VERSION}}               ║"
        echo "╚══════════════════════════════════════════════════════════════╝"
        echo ""
        PASS_COUNT=0
        FAIL_COUNT=0

        # 1. Prerequisites check
        echo "1. Checking prerequisites..."
        if command -v node >/dev/null 2>&1; then
          echo "   ✓ Node.js $(node -v)"
          PASS_COUNT=$((PASS_COUNT + 1))
        else
          echo "   ✗ Node.js not found"
          FAIL_COUNT=$((FAIL_COUNT + 1))
          echo "   Install: https://nodejs.org/"
          exit 1
        fi

        if command -v docker >/dev/null 2>&1; then
          echo "   ✓ Docker $(docker --version 2>/dev/null | cut -d' ' -f3 | tr -d ',')"
        else
          echo "   ⚠ Docker not found (optional for local dev)"
        fi

        if command -v task >/dev/null 2>&1; then
          echo "   ✓ Task runner available"
        else
          echo "   ⚠ Task runner not found (you're running it though!)"
        fi

        # 2. Install aws-sandbox
        echo ""
        echo "2. Installing aws-sandbox@{{.VERSION}}..."
        if npm install -g aws-sandbox@{{.VERSION}} --ignore-scripts 2>&1 | tail -3; then
          PASS_COUNT=$((PASS_COUNT + 1))
        else
          echo "   ⚠ Install had warnings (may still work)"
        fi

        # 3. Version verification
        echo ""
        echo "3. Verifying installation..."
        if aws-sandbox --version 2>/dev/null | head -1; then
          PASS_COUNT=$((PASS_COUNT + 1))
        else
          echo "   ✗ aws-sandbox command not found"
          FAIL_COUNT=$((FAIL_COUNT + 1))
        fi

        # 4. Tier 1 test
        echo ""
        echo "4. Running Tier 1 test (CLI validation)..."
        if aws-sandbox test --tier=1 2>&1; then
          PASS_COUNT=$((PASS_COUNT + 1))
        else
          echo "   ⚠ Tier 1 test completed with warnings"
        fi

        # 5. Tier 2 test
        echo ""
        echo "5. Running Tier 2 test (LocalStack connectivity)..."
        if aws-sandbox test --tier=2 2>&1; then
          PASS_COUNT=$((PASS_COUNT + 1))
        else
          echo "   ⚠ Tier 2 test completed with warnings"
        fi

        # 6. Evidence generation
        echo ""
        echo "6. Generating evidence..."
        task sandbox:evidence:generate 2>/dev/null || echo "   ⚠ Evidence generation skipped"

        # Summary
        echo ""
        echo "╔══════════════════════════════════════════════════════════════╗"
        echo "║                    QUICK START COMPLETE                      ║"
        echo "╠══════════════════════════════════════════════════════════════╣"
        echo "║  Passed: $PASS_COUNT    Failed: $FAIL_COUNT                              ║"
        echo "╠══════════════════════════════════════════════════════════════╣"
        echo "║  Evidence: {{.EVIDENCE_DIR}}/                       ║"
        echo "╠══════════════════════════════════════════════════════════════╣"
        echo "║  Next Steps:                                                 ║"
        echo "║    - View results: cat {{.EVIDENCE_DIR}}/05-summary.md       ║"
        echo "║    - Full deploy: Clone sandbox repo (requires source)       ║"
        echo "║    - Docs: https://www.npmjs.com/package/aws-sandbox         ║"
        echo "╚══════════════════════════════════════════════════════════════╝"

  quickstart:help:
    desc: Show quickstart instructions (no execution)
    cmds:
      - |
        echo "AWS Sandbox Quick Start Guide"
        echo "============================="
        echo ""
        echo "Option 1: VSCode/Codespaces (recommended)"
        echo "  1. Open this folder in VSCode"
        echo "  2. Click 'Reopen in Container' when prompted"
        echo "  3. Run: task quickstart"
        echo ""
        echo "Option 2: Run quickstart directly"
        echo "  task quickstart    # Full end-to-end validation"
        echo ""
        echo "Option 3: Manual steps"
        echo "  task install       # Install aws-sandbox"
        echo "  task test:tier1    # Run Tier 1 tests"
        echo "  task test:tier2    # Run Tier 2 tests"
        echo ""
        echo "Available Tasks:"
        task --list

  install:
    desc: Install aws-sandbox from npm
    cmds:
      - task: sandbox:install

  test:
    desc: Run Tier 1+2 tests
    cmds:
      - task: sandbox:test

  deploy:
    desc: Deploy to LocalStack
    cmds:
      - task: sandbox:deploy

  upgrade:
    desc: Upgrade to latest version
    cmds:
      - task: sandbox:upgrade

  test:tier1:
    desc: Run Tier 1 snapshot tests only
    cmds:
      - task: sandbox:test:tier1

  test:tier2:
    desc: Run Tier 2 LocalStack tests only
    cmds:
      - task: sandbox:test:tier2
